{% extends "base.html" %}
{% block title %}{{ challenge.title }} â€” RedPawn SOC Lab{% endblock %}

{% block content %}
<div class="challenge-page">
    <!-- Challenge Header -->
    <div class="challenge-header">
        <a href="{{ url_for('dashboard') }}" class="back-link">â† Retour au dashboard</a>
        <div class="challenge-title-bar">
            <div>
                <h1>{{ challenge.title }}</h1>
                <div class="challenge-meta">
                    <span class="meta-badge level" style="background: {{ level_info.color }}20; color: {{ level_info.color }}">
                        {{ level_info.icon }} {{ level_info.name }}
                    </span>
                    <span class="meta-badge category">
                        {{ category_info.icon }} {{ category_info.name }}
                    </span>
                    <span class="meta-badge time">â±ï¸ {{ challenge.estimated_time }}</span>
                    <span class="meta-badge points">ğŸ† {{ points_earned }} / {{ challenge.points_total }} pts</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Story / Briefing -->
    <details class="story-section" open>
        <summary class="story-toggle">ğŸ“‹ Briefing de Mission</summary>
        <div class="story-content markdown">
            {{ challenge.story | markdown }}
        </div>
    </details>

    <!-- Artifacts -->
    <details class="artifacts-section" open>
        <summary class="artifacts-toggle">ğŸ“ Artefacts ({{ challenge.artifacts|length }})</summary>
        <div class="artifacts-container">
            {% for artifact in challenge.artifacts %}
            <div class="artifact-card">
                <div class="artifact-header">
                    <span class="artifact-icon">
                        {% if artifact.type == 'log' %}ğŸ“‹
                        {% elif artifact.type == 'email' %}âœ‰ï¸
                        {% elif artifact.type == 'code' %}ğŸ’»
                        {% elif artifact.type == 'siem' %}ğŸ””
                        {% elif artifact.type == 'windows_events' %}ğŸªŸ
                        {% elif artifact.type == 'ransom_note' %}ğŸ’€
                        {% elif artifact.type == 'timeline' %}â±ï¸
                        {% elif artifact.type == 'forensic_report' %}ğŸ”¬
                        {% elif artifact.type == 'report' %}ğŸ“Š
                        {% elif artifact.type == 'intelligence_report' %}ğŸ•µï¸
                        {% elif artifact.type == 'dlp_log' %}ğŸ”’
                        {% elif artifact.type == 'confidential' %}ğŸ”
                        {% else %}ğŸ“„
                        {% endif %}
                    </span>
                    <div>
                        <h4>{{ artifact.name }}</h4>
                        <p class="artifact-desc">{{ artifact.description }}</p>
                    </div>
                    <button class="btn btn-sm btn-outline copy-artifact" data-artifact="{{ loop.index0 }}" title="Copier le contenu">
                        ğŸ“‹ Copier
                    </button>
                    <button class="btn btn-sm btn-outline download-artifact" data-filename="{{ artifact.name }}" title="TÃ©lÃ©charger l'artefact">
                        â¬‡ï¸ TÃ©lÃ©charger
                    </button>
                </div>
                <div class="artifact-content">
                    <pre><code>{{ artifact.content }}</code></pre>
                </div>
            </div>
            {% endfor %}
        </div>
    </details>

    <!-- Questions -->
    <div class="questions-section">
        <h2>ğŸ¯ Questions ({{ solved_questions|length }}/{{ questions|length }})</h2>
        
        {% for q in questions %}
        <div class="question-card {% if q.is_solved %}solved{% endif %}" id="question-{{ q.id }}">
            <div class="question-header">
                <div class="question-number">
                    {% if q.is_solved %}
                    <span class="q-status solved">âœ…</span>
                    {% else %}
                    <span class="q-status pending">{{ loop.index }}</span>
                    {% endif %}
                </div>
                <div class="question-text">
                    <p>{{ q.text }}</p>
                </div>
                <div class="question-points">
                    <span class="points-badge">{{ q.points }} pts</span>
                </div>
            </div>

            {% if not q.is_solved %}
            <div class="question-body">
                <div class="answer-form">
                    <div class="input-group">
                        <input type="text" 
                               class="answer-input" 
                               id="answer-{{ q.id }}" 
                               placeholder="Votre rÃ©ponse (format : REDPAWN{...})"
                               data-challenge="{{ challenge.id }}"
                               data-question="{{ q.id }}"
                               autocomplete="off">
                        <button class="btn btn-primary submit-btn" 
                                onclick="submitAnswer('{{ challenge.id }}', '{{ q.id }}')">
                            Valider
                        </button>
                    </div>
                    <div class="answer-feedback" id="feedback-{{ q.id }}"></div>
                </div>

                <!-- Hints -->
                {% if q.hints_available > 0 %}
                <div class="hints-section">
                    <button class="btn btn-hint" 
                            onclick="requestHint('{{ challenge.id }}', '{{ q.id }}')"
                            {% if q.hints_used_count >= q.hints_available %}disabled{% endif %}>
                        ğŸ’¡ Indice ({{ q.hints_used_count }}/{{ q.hints_available }}) 
                        {% if q.hints_used_count < q.hints_available %}
                        â€” coÃ»t: -{{ q.hint_cost }} pts
                        {% else %}
                        â€” tous utilisÃ©s
                        {% endif %}
                    </button>
                    <div class="hints-list" id="hints-{{ q.id }}">
                        {% for hint_text in q.hints_revealed %}
                        <div class="hint-card revealed">
                            <span class="hint-icon">ğŸ’¡</span>
                            <span class="hint-text">{{ hint_text }}</span>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
            {% else %}
            <div class="question-solved-info">
                <span class="solved-badge">âœ… RÃ©ponse validÃ©e</span>
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}
