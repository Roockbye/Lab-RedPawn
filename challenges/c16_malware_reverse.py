"""
Challenge 16 — Reverse Engineering Malware
Niveau : 5 (Threat Hunter)
Catégorie : Reverse Engineering
"""

ARTIFACT_MALWARE_REPORT = r"""
========== RAPPORT D'ANALYSE MALWARE — health_check.exe ==========
Analyste : CERT-SOC RedPawn
Date : 18/02/2026
Classification : CONFIDENTIEL
Outil : IDA Pro 8.3, x64dbg, PE-bear, FLOSS, VirusTotal

===== MÉTADONNÉES PE =====
Nom fichier    : health_check.exe
SHA256         : a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
MD5            : 7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c
SSDeep         : 12288:xYz3Ab4Cd5:xYz3Ab4Cd5
Taille         : 458752 bytes (448 KB)
Type           : PE32+ executable (GUI) x86-64
Compilateur    : MSVC 14.36 (Visual Studio 2022)
Timestamp      : 2026-02-13 19:44:12 UTC
Packer         : UPX 4.2.2 (détecté par Detect It Easy)
Entropy        : 7.89 (haute — confirme le packing)
Après unpack   : 1.2 MB, entropy 5.34

===== ANALYSE VIRUSTOTAL =====
Première soumission : 2026-02-18 16:00:00 UTC
Détection : 3/72 (au moment de l'analyse)
  - CrowdStrike : Win64/PhantomLoader.A
  - SentinelOne : Trojan.GenericKD.71234567
  - Kaspersky   : HEUR:Trojan.Win64.Agent.gen
Commentaires   : Pas de détection par Windows Defender, ESET, Bitdefender
Catégorie      : Trojan / Loader

===== ANALYSE DES STRINGS (FLOSS — après unpack) =====
[...strings pertinentes extraites...]

--- Strings ASCII ---
WinDefHealthCheck
Microsoft Corporation
Windows Defender Health Service
PERS1ST_M0DUL3
cmd.exe /c whoami
cmd.exe /c systeminfo
cmd.exe /c net user /domain
cmd.exe /c nltest /dclist:
cmd.exe /c net group "Domain Admins" /domain
C:\Windows\Temp\
C:\ProgramData\Microsoft\Crypto\
\.pipe\health_svc_pipe
svcctl
schtasks /create /tn "WinDefUpdate" /tr
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Content-Type: application/octet-stream
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
X-Session-ID:
X-Host-ID:
AES-256-CBC
PKCS7

--- Strings encodées (déobfusquées par FLOSS) ---
config_decrypt_key: Ph4nt0mCr4n3_2026!
api_path: /api/v2/beacon
sleep_interval: 60
jitter_pct: 5
max_retries: 3
kill_date: 2026-06-15
proxy_aware: true
inject_method: early_bird
target_process: RuntimeBroker.exe
c2_primary: 185.234.72.19
c2_port: 443
c2_fallback: 91.234.56.78
c2_fallback_port: 8443
protocol: https
cert_pin: sha256/9f3a2b8c1d4e5f6a7b8c9d0e1f2a3b4c...

===== ANALYSE DES IMPORTS (IAT) =====
--- kernel32.dll ---
CreateProcessA, CreateProcessW
VirtualAllocEx, VirtualProtectEx, WriteProcessMemory
CreateRemoteThread
OpenProcess, TerminateProcess
CreateMutexA, OpenMutexA
CreateThread, SuspendThread, ResumeThread, QueueUserAPC
GetModuleHandleA, GetProcAddress, LoadLibraryA
IsDebuggerPresent, CheckRemoteDebuggerPresent
GetTickCount64, QueryPerformanceCounter, QueryPerformanceFrequency

--- ntdll.dll ---
NtCreateSection, NtMapViewOfSection, NtUnmapViewOfSection
NtAllocateVirtualMemory, NtWriteVirtualMemory
NtQueueApcThread, NtSetContextThread
RtlAdjustPrivilege

--- advapi32.dll ---
OpenServiceW, CreateServiceW, StartServiceW
RegSetValueExA, RegOpenKeyExA
AdjustTokenPrivileges, OpenProcessToken
CreateProcessAsUserW, LogonUserW
LookupPrivilegeValueA

--- ws2_32.dll ---
WSAStartup, socket, connect, send, recv
inet_addr, htons, gethostbyname

--- winhttp.dll ---
WinHttpOpen, WinHttpConnect, WinHttpOpenRequest
WinHttpSendRequest, WinHttpReceiveResponse
WinHttpSetOption

===== ANALYSE COMPORTEMENTALE (Sandbox ANY.RUN) =====
Exécution de 10 minutes en sandbox :

00:00 — Démarrage, unpacking UPX en mémoire
00:01 — Anti-analyse : vérifie IsDebuggerPresent → environnement propre
00:01 — Anti-analyse : GetTickCount64 timing check (détection VM)
00:02 — Anti-analyse : vérifie la présence de "vmtoolsd.exe", "vboxservice.exe"
00:03 — Crée le mutex PERS1ST_M0DUL3 (si existe déjà → quitte)
00:04 — Exécute whoami, systeminfo, net user /domain (reconnaissance)
00:05 — Injection dans RuntimeBroker.exe via technique Early Bird APC Injection
00:06 — Connexion HTTPS vers 185.234.72.19:443, beacon initial
00:07 — Reçoit tasking, télécharge mimikatz en mémoire
00:08 — Extraction credentials LSASS
00:09 — Upload credentials vers C2
00:10 — Boucle de beaconing (sleep 60s + jitter 5%)

Techniques anti-analyse détectées :
  1. IsDebuggerPresent API check
  2. Timing check (GetTickCount64 delta > 1000ms → sandbox detectée)
  3. Process name check (vmtoolsd, vboxservice, procmon, wireshark, x64dbg)
  4. Disk size check (< 60 GB → VM probable)
  5. CPU core check (< 2 cores → VM probable)
  6. Username check ("admin", "user", "test", "sandbox" → mauvais signe)
  7. Registry check (VMWare/VBox keys)

===== RÈGLES YARA =====
rule PhantomLoader_HealthCheck {
    meta:
        description = "Détection du loader PHANTOM CRANE - health_check.exe"
        author = "CERT RedPawn"
        date = "2026-02-18"
        hash = "a1b2c3d4e5f6..."
    strings:
        $mutex = "PERS1ST_M0DUL3" ascii
        $config_key = "Ph4nt0mCr4n3_2026!" ascii
        $pipe = "\\\\.\\pipe\\health_svc_pipe" ascii
        $ua = "X-Session-ID:" ascii
        $inject = "RuntimeBroker.exe" ascii wide
        $packer = { 55 50 58 21 } // "UPX!"
    condition:
        uint16(0) == 0x5A4D and
        filesize < 2MB and
        3 of ($mutex, $config_key, $pipe, $ua, $inject) and
        $packer
}

===== RÉSUMÉ C2 =====
Type           : Custom HTTPS beacon (style Cobalt Strike)
Serveur primaire : 185.234.72.19:443
Serveur fallback : 91.234.56.78:8443
Protocole      : HTTPS avec certificate pinning
Chiffrement    : AES-256-CBC avec PKCS7 padding
Beacon interval: 60 secondes
Jitter         : 5%
Kill date      : 15/06/2026
API path       : /api/v2/beacon
"""

CHALLENGE = {
    "id": "c16_malware_reverse",
    "title": "⚙️ Le Cœur de la Bête",
    "category": "reverse_engineering",
    "level": 5,
    "points_total": 560,
    "estimated_time": "50-70 min",
    "story": """
## Briefing de Mission

**Date :** 18 février 2026, 17h00
**Priorité :** HAUTE
**Source :** Équipe Malware Analysis / CERT

---

L'exécutable `health_check.exe` récupéré par l'équipe forensique a été analysé en profondeur. Le rapport complet est disponible : analyse statique, dynamique, strings, imports, sandbox, et règle YARA.

> *"On a fully reversé le loader de PHANTOM CRANE. C'est du custom, bien codé, avec de l'anti-analyse, de l'injection de processus, du certificate pinning. Fouille le rapport et dis-moi tout sur ses capacités, sa configuration C2, et ses mécanismes d'évasion."*

Reverse engineering avancé. Ce challenge teste votre capacité à lire un rapport de malware analysis.
    """,
    "artifacts": [
        {
            "name": "malware_analysis_report.txt",
            "type": "forensic_report",
            "content": ARTIFACT_MALWARE_REPORT,
            "description": "Rapport complet d'analyse malware — health_check.exe"
        }
    ],
    "questions": [
        {
            "id": "q1",
            "text": "Quel est le mot de passe/clé utilisé pour déchiffrer la configuration du malware ?",
            "answer": "Ph4nt0mCr4n3_2026!",
            "flag": "REDPAWN{Ph4nt0mCr4n3_2026!}",
            "points": 50,
            "hints": [
                "Cherchez dans les strings déobfusquées par FLOSS",
                "C'est le champ 'config_decrypt_key'"
            ],
            "hint_cost": 17
        },
        {
            "id": "q2",
            "text": "Quelle technique d'injection de processus est utilisée par le malware ? (nom complet)",
            "answer": "Early Bird APC Injection",
            "flag": "REDPAWN{Early_Bird_APC_Injection}",
            "points": 60,
            "hints": [
                "Regardez la configuration déobfusquée (inject_method) et l'analyse sandbox",
                "C'est une technique qui utilise QueueUserAPC avant la reprise du thread"
            ],
            "hint_cost": 20
        },
        {
            "id": "q3",
            "text": "Dans quel processus légitime le malware s'injecte-t-il ?",
            "answer": "RuntimeBroker.exe",
            "flag": "REDPAWN{RuntimeBroker.exe}",
            "points": 40,
            "hints": [
                "C'est dans la configuration et dans l'analyse sandbox",
                "C'est le champ 'target_process'"
            ],
            "hint_cost": 13
        },
        {
            "id": "q4",
            "text": "Combien de techniques anti-analyse/anti-debug le malware utilise-t-il ?",
            "answer": "7",
            "flag": "REDPAWN{7}",
            "points": 40,
            "hints": [
                "Comptez dans la section 'Techniques anti-analyse détectées'"
            ],
            "hint_cost": 13
        },
        {
            "id": "q5",
            "text": "Quelle est la date de 'kill date' programmée du malware ? (format YYYY-MM-DD)",
            "answer": "2026-06-15",
            "flag": "REDPAWN{2026-06-15}",
            "points": 40,
            "hints": [
                "Cherchez 'kill_date' dans la configuration déobfusquée"
            ],
            "hint_cost": 13
        },
        {
            "id": "q6",
            "text": "Quel algorithme de chiffrement est utilisé pour les communications C2 ?",
            "answer": "AES-256-CBC",
            "flag": "REDPAWN{AES-256-CBC}",
            "points": 50,
            "hints": [
                "Regardez les strings ou le résumé C2",
                "C'est un chiffrement symétrique par blocs"
            ],
            "hint_cost": 17
        },
        {
            "id": "q7",
            "text": "Combien d'antivirus sur 72 détectaient le malware au moment de l'analyse VirusTotal ?",
            "answer": "3",
            "flag": "REDPAWN{3}",
            "points": 30,
            "hints": [
                "Regardez la section Analyse VirusTotal"
            ],
            "hint_cost": 10
        },
        {
            "id": "q8",
            "text": "Quel outil a été téléchargé en mémoire par le malware pour extraire les credentials ?",
            "answer": "mimikatz",
            "flag": "REDPAWN{mimikatz}",
            "points": 40,
            "hints": [
                "C'est dans l'analyse comportementale sandbox, à 00:07"
            ],
            "hint_cost": 13
        },
        {
            "id": "q9",
            "text": "Quel est le chemin API utilisé pour les communications beacon ? (commence par /)",
            "answer": "/api/v2/beacon",
            "flag": "REDPAWN{/api/v2/beacon}",
            "points": 50,
            "hints": [
                "Cherchez 'api_path' dans la configuration déobfusquée"
            ],
            "hint_cost": 17
        },
        {
            "id": "q10",
            "text": "Quelle version de Visual Studio a compilé ce malware ?",
            "answer": "2022",
            "flag": "REDPAWN{2022}",
            "points": 40,
            "hints": [
                "Regardez le champ Compilateur dans les métadonnées PE",
                "MSVC 14.36 correspond à quelle version de VS ?"
            ],
            "hint_cost": 13
        },
        {
            "id": "q11",
            "text": "Combien de strings doivent matcher (condition minimum) pour que la règle YARA détecte le malware ?",
            "answer": "3",
            "flag": "REDPAWN{3}",
            "points": 60,
            "hints": [
                "Regardez la condition de la règle YARA",
                "Il faut 'X of ($mutex, $config_key, ...)'"
            ],
            "hint_cost": 20
        },
        {
            "id": "q12",
            "text": "Quel named pipe est créé par le malware pour la communication inter-processus ?",
            "answer": "health_svc_pipe",
            "flag": "REDPAWN{health_svc_pipe}",
            "points": 50,
            "hints": [
                "Cherchez '.pipe' dans les strings",
                "C'est un mécanisme Windows de communication entre processus"
            ],
            "hint_cost": 17
        }
    ]
}
